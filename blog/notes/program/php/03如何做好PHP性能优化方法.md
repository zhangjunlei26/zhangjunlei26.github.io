#如何做好PHP性能优化
## 1 规范说明
性能是网站运行是否良好的关键因素， 网站的性能与效率影响着公司的运营成本及长远发展，编写出高质高效的代码是我们每个开发人员必备的素质,也是我们良好的职业素养。

## 2 影响性能的因素

### 2.1 商业需求
1.需求合理性
2.需求与系统的整合
3.需求所带来的商业利益是否与需求开发的成本成正比
4.需求所带来的风险

###2.2 Web 服务器
1.并发处理能力
2.高负载的能力
3.负载均衡的能力
4.动态内容与静态内容的处理能力
5.Web 服务器部署
###2.3 DataBase 服务器

* 并发访问
* 数据库服务器的部署
* 数据库的 shema 架构与的表设计是否合理
* 数据检索

###2.4 操作系统
###2.5 客户端请求
###2.6 程序/语言

## 3 分析性能的指标
1.程序的运行时间
2.程序的运行所消耗的内存
3.单位时间内的并行处理
4.磁盘 IO 的处理
## 4 优化性能的目标
快速、并发、资源消耗低（内存、磁盘 IO、CPU 负载）

## 5 优化性能的原则
1.服务器配配置最优化
2.服务器部署合理化
3.商业需求合理并与产出的商业价值成正比
4.架构可用、可维护、可扩展
5.程序的正确性、简单性、逻辑的合理性。
6.不断的分析性能的的瓶颈
7.不断的重构已有的代码
8.优化的优先级：program->database->web sersver->os->client

## 6 优化
### 6.1 程序优化
#### 6.1.1 变量
1、 变量大小,注意变量大小是节约内存的最有效手段，对于来自用户表单、数据库和文件缓存的数据都需要控制变量的大小。 因为cpu要处理的数据是来源于内存
2、 变量有效期，使用unset()函数注销不需要的变量是一种良好的习惯，将一些不需要的变量立即注销可提高内存的使用率。
3、 复制变量
$a=1;$b=&a;$c=a;
php7之前的版本，$c会导致重新复制一份，php7会在$c重新复制时才生成新的zval。
4、 变量类型,初始化变量请注意其变量类型，一个变量在执行过程中最好只有一种类型状态。对于数组变量，请初始化声明，如下： $a = array();
5、 临时变量,是处理业务逻辑的临时存储，这些都是需要消耗内存的。如果临时变量使用结束请立即注销，特别是在一些过程式代码的执行流程中，对于一些函数，如果业务非常复杂，同样需要立即注销临时变量
6、 静态变量,对于一些需要由复杂业务产生的变量，如果在程序的执行过程中多次产生并使用，可考虑使用静态变量，减少程序的cpu执行次数
7、 变量的性能：局部变量>全局变量>类属性>未定义的变量。
8、 注销那些不用的变量尤其是大数组，以便释放内存。
9、递增一个全局变量要比递增一个局部变量慢2倍。
10、在方法中递增局部变量，速度是最快的。几乎与在函数中调用局部变量的速度相当。
11、递增一个对象属性（如：$this->prop++）要比递增一个局部变量慢3倍。
12、递增一个未预定义的局部变量要比递增一个预定义的局部变量慢9至10倍。
13、仅定义一个局部变量而没在函数中调用它，同样会减慢速度（其程度相当于递增一个局部变量）。PHP大概会检查看是否存在全局变量。
14、并非要用类实现所有的数据结构，数组也很有用。
15、用i+=1代替i=i+1。符合c/c++的习惯，效率还高。
16、对global变量，应该用完就unset()掉。

#### 6.1.2 循环
1、 尽量减少循环的次数。
2、 尽量减少循环的潜逃的层次，不要超过三层。
3、 避免在循环内有过多的业务逻辑。
4、 不要循环包含文件
5、 不要循环执行数据库操作。
6、 优先使用foreach,它比for/while效率高
7、 不要把 count/strlen/sizeof 放到 for 循环的条件语句中 for($i=0,$count=count($array);$i<$count;$i++){} 不要使用for($i=0;$i<count($array);$i++){};
8、 for($i=$total;$i>0;$i--){}性能好于for($i=0;$i<$total;$i--){}
9、 保持循环体内的业务逻辑清晰

#### 6.1.3 函数/方法
1、 函数职责清晰，一个函数只干一件事，不要杂揉过多的业务逻辑
2、 函数代码体不要超过20行，反之，考虑拆分。
3、 优先使用php内置函数
4、 常量与函数同时能干一件事，优先使用常量。
phpversion() < PHP_VERSION
get_class() < __CLASS__
is_null() < NULL ===
5、 echo 的性能好于print,输入多个变量的时候用echo $str,$str1,不用.连接符
6、 $_SERVER[REQUEST_TIME]替换time();
7、 字符串替换strtr()->str_replace()->preg_replace()->epreg();
8、 发挥trim最大功效，替换substr。$filepath=trim($filename,’/’).’/’;
9、Isset/empty 虽然两个函数功能有所差异，但在同样的情况下推荐使用 empty()
10、isfile/file_exist 两个函数的功能有所不同，file_exist既可判断文件是否存在，也可以判断目录是否存在，在同样的情况下推荐使用is_file
11、如果能将类的方法定义成static，就尽量定义成static，它的速度会提升将近4倍。
12、尽量避免使用__get，__set，__autoload。
13、方法调用看来与类中定义的方法的数量无关，因为我（在测试方法之前和之后都）添加了10个方法，但性能上没有变化
14、派生类中的方法运行起来要快于在基类中定义的同样的方法。
15、调用带有一个参数的空函数，其花费的时间相当于执行7至8次的局部变量递增操作。类似的方法调用所花费的时间接近于15次的局部变量递增操作。
16、尽量采用内置函数


#### 6.1.4 文件
1、开启opcache，可直接从opcode缓存中加载文件。lstat64调用多了之后，主机CPU和IO都会比较高。
2、使用完整路径，或者容易转换的相对路径。避免在 include_path 查找.
3、按需要加载，减少文件包含数
4、文件的代码行数不要超过 2000 行
6、避免使用Require_once/include_once，其效率低于 require/include, 需要额外的去查看系统是否已经调用过这个文件. 它们在一个 opcode 缓存下的调用非常慢。
7、程序执行文件用requie,缓存文件用include，Include 效率好于 require。
8、自动加载，以全代码更清晰，用spl_autoload_register代替__autoload。
9、类库文件加载，是否考虑类是否已经实例化，可考虑采用设计模式之单例模式
10、文件读写的并发性
11、 合理设定php.ini中的realpath_cache_size和realpath_cache_ttl参数
12、realpath_cache_get()可以获取的已经加载文件路径的缓存，依次判断，可以避免lstat64调用。
13、在可以用file_get_contents替代file、fopen、feof、fgets等系列方法的情况下，尽量用file_get_contents，因为他的效率高得多！但是要注意file_get_contents在打开一个URL文件时候的PHP版本问题；


#### 6.1.5 面向对象
1、 控制实例的创建的数量
2、 优先使用常量、类常量
3、 优先例用静态变量，静态属性
4、 类的结构合理
5、 面象接口编程
6、 封装变化点
7、 依赖于抽象，不依赖于细节
8、 优先使用静态成员
9、 类的接口清晰稳定，类的职责单一，类与类的通信合理
10、 使用常量的好处 编译时解析，没有额外开销 杂凑表更小，所以内部查找更快 类常量仅存在于特定「命名空间」，所以杂凑名更短 代码更干净，使除错更方便

#### 6.1.6 字符串
1、用单引号替代双引号引用字符串常量，因为PHP会在双引号包围的字符串中搜寻变量，单引号则不会。
2、echo 比print 快，并且使用echo的多重参数代替字符串连接，比如echo $str1,$str2代替echo $str1.str2;
3、函数代替正则表达式完成相同功能。
4、str_replace函数比preg_replace函数快，但strtr函数的效率是str_replace函数的四倍。
5、如果一个字符串替换函数，可接受数组或字符作为参数，并且参数长度不太长，那么可以考虑额外写一段替换代码，使得每次传递参数是一个字符，而不是只写一行代码接受数组作为查询和替换的参数。
6、strlen()是函数，在某些情况下，你可以使用isset() 技巧加速执行你的代码。isset()作为一种语言结构，意味着它的执行不需要函数查找和字母小写化。
7、在可以用PHP内部字符串操作函数的情况下，不要用正则表达式。




#### 6.1.7 运算
1、 用 i+=1 代替i=i+1。符合c/c++的习惯，效率还高
2、 ++$i 的效率高于++$i,–$i 同理

#### 6.1.8 数组
1、 多维数组尽量不要循环嵌套赋值；
2、 使用$array[‘name’]方式访问数组，禁止$array[name]/$array[“name”],$row[’id’] 的速度是$row[id]的7倍。

#### 6.1.9 判断
1、 逻辑判断请优先使用switch 的方式，对于业务逻辑相对较多的情况请选择if/else，提高代码的可读性
2、 尽量控制if/else判断的个数，如果太多请考虑功能优化或代码优化
3、 尽量使用恒等用于比较判断，恒等的效率高于等于，而且还能避免一些类型强制转换的错误
4、 if/else与_&&,单条语句判断请选择&&的形式， &&的效率高于if/else，如下 :
if ($a == 1) {
$b = 2;
}可选择为($a == 1) && $b = 2;

#### 6.1.10 缓存

1、 使用php加速器，缓冲opcode，否则每次调用时都会重新编译一次。引入一套PHP缓存机制通常可以提升25%至100%的性能，以免除编译开销。
2、 尽量做缓存，可使用memcached/redis等减轻数据库负载。
3、 使用内存数据库、
4、 使用文件缓存
5、 缓冲功能   5

#### 6.1.11 其它
1、 少用@符号，严重影响性能
2、 适时关闭远程资源连接如数据库，ftp、socket等，适时的清理这些资源
3、如果你想知道脚本开始执行（译注：即服务器端收到客户端请求）的时刻，使用$_SERVER[‘REQUEST_TIME’]要好于time()。
4、错误消息代价昂贵。


### 6.2 数据库优化
1、 合理的商业需情
2、 数据库 schema 架构优化
3、 垂直与水平分库分表
4、 索引优化，查询优化
5、 第三方开源检索工具(sphinx)
6、 主从数据库服务器的使用。
### 6.3 Web 服器优化（暂未整理,有相应的 Web 服务器优化手册）
### 6.4 操作系统优化(暂未整理,有相应的 OS 优化手册)
### 6.5 前端优化
1、合理的 html 结构
2、合理 html 与css 的同时，考虑 Css 设计合理，减少 http 请求
3、合理 html 与javascript 的同时，考虑拆分是否合理，减少 http 请求
4、优化 javascript 代码，让用户有良好的体验
5、根据 http 协议，优化高并发请求

## 7 性能检测工具
Web Server
ab
http_load
PHP
apd
xdebug
Mysql
explain
profiler