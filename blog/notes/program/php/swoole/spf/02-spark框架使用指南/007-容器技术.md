## 8 å®¹å™¨ Container

### 8.1 å®¹å™¨æ¦‚è¿°

#### 8.1.1 æ¦‚è¿°

å®¹å™¨æ˜¯ä¸€ç§ç®¡ç†ç±»ä¾èµ–å…³ç³»çš„å¼ºå¤§å·¥å…·ã€‚å®¹å™¨èƒ½å¤Ÿè£…ä»€ä¹ˆï¼Œå…¨éƒ¨å–å†³äºä½ å¯¹è¯¥å®¹å™¨çš„å®šä¹‰ã€‚å®¹å™¨æ¦‚å¿µçš„å¼•å…¥ï¼Œæˆ‘ä»¬å¾—ä»¥å®ç°è®¸å¤šé«˜çº§åŠŸèƒ½ï¼Œè½»æ˜“å®ç°è§£è€¦ã€ä¾èµ–æ³¨å…¥ç­‰ç‰¹æ€§ï¼Œæé«˜é¡¹ç›®çš„å¯ç»´æŠ¤æ€§ã€‚å®¹å™¨æ˜¯spfå®ç°çš„æ ¸å¿ƒï¼Œæœ¬ç« çš„å°†ä»ä¸€äº›åŸºç¡€å†…å®¹å¼€å§‹è®²è§£ï¼Œé€šè¿‡ç†è§£é¢å‘å¯¹è±¡å¼€å‘ä¸­ä¾èµ–çš„äº§ç”Ÿå’Œè§£å†³æ–¹æ³•ï¼Œæ¥é€æ¸æ­å¼€â€œä¾èµ–æ³¨å…¥â€çš„é¢çº±ï¼Œé€æ¸ç†è§£è¿™ä¸€ç¥å¥‡çš„è®¾è®¡ç†å¿µã€‚

#### 8.1.2 ç›¸å…³æ¦‚å¿µ

- ä¾èµ–å€’ç½®åŸåˆ™ï¼ˆDependence Inversion Principle, DIPï¼‰
  
  DIPæ˜¯ä¸€ç§è½¯ä»¶è®¾è®¡çš„æŒ‡å¯¼æ€æƒ³ã€‚ä¼ ç»Ÿè½¯ä»¶è®¾è®¡ä¸­ï¼Œä¸Šå±‚ä»£ç ä¾èµ–äºä¸‹å±‚ä»£ç ï¼Œå½“ä¸‹å±‚å‡ºç°å˜åŠ¨æ—¶ï¼Œ ä¸Šå±‚ä»£ç ä¹Ÿè¦ç›¸åº”å˜åŒ–ï¼Œç»´æŠ¤æˆæœ¬è¾ƒé«˜ã€‚è€ŒDIPçš„æ ¸å¿ƒæ€æƒ³æ˜¯ä¸Šå±‚å®šä¹‰æ¥å£ï¼Œä¸‹å±‚å®ç°è¿™ä¸ªæ¥å£ï¼Œ ä»è€Œä½¿å¾—ä¸‹å±‚ä¾èµ–äºä¸Šå±‚ï¼Œé™ä½è€¦åˆåº¦ï¼Œæé«˜æ•´ä¸ªç³»ç»Ÿçš„å¼¹æ€§ã€‚è¿™æ˜¯ä¸€ç§ç»å®è·µè¯æ˜çš„æœ‰æ•ˆç­–ç•¥ã€‚
  
- æ§åˆ¶åè½¬ï¼ˆInversion of Control, IoCï¼‰
  
  IoCå°±æ˜¯DIPçš„ä¸€ç§å…·ä½“æ€è·¯ï¼ŒDIPåªæ˜¯ä¸€ç§ç†å¿µã€æ€æƒ³ï¼Œè€ŒIoCæ˜¯ä¸€ç§å®ç°DIPçš„æ–¹æ³•ã€‚ IoCçš„æ ¸å¿ƒæ˜¯å°†ç±»ï¼ˆä¸Šå±‚ï¼‰æ‰€ä¾èµ–çš„å•å…ƒï¼ˆä¸‹å±‚ï¼‰çš„å®ä¾‹åŒ–è¿‡ç¨‹äº¤ç”±ç¬¬ä¸‰æ–¹æ¥å®ç°ã€‚ ä¸€ä¸ªç®€å•çš„ç‰¹å¾ï¼Œå°±æ˜¯ç±»ä¸­ä¸å¯¹æ‰€ä¾èµ–çš„å•å…ƒæœ‰è¯¸å¦‚$componentÂ =Â newÂ component\SomeDependedClassï¼ˆï¼‰Â çš„å®ä¾‹åŒ–è¯­å¥ã€‚
  
- ä¾èµ–æ³¨å…¥ï¼ˆDependence Injection, DIï¼‰
  
  DIæ˜¯IoCçš„ä¸€ç§è®¾è®¡æ¨¡å¼ï¼Œæ˜¯ä¸€ç§å¥—è·¯ï¼ŒæŒ‰ç…§DIçš„å¥—è·¯ï¼Œå°±å¯ä»¥å®ç°IoCï¼Œå°±èƒ½ç¬¦åˆDIPåŸåˆ™ã€‚ DIçš„æ ¸å¿ƒæ˜¯æŠŠç±»æ‰€ä¾èµ–çš„å•å…ƒçš„å®ä¾‹åŒ–è¿‡ç¨‹ï¼Œæ”¾åˆ°ç±»çš„å¤–é¢å»å®ç°ã€‚
  
- æ§åˆ¶åè½¬å®¹å™¨ï¼ˆIoC Containerï¼‰
  
  å½“é¡¹ç›®æ¯”è¾ƒå¤§æ—¶ï¼Œä¾èµ–å…³ç³»å¯èƒ½ä¼šå¾ˆå¤æ‚ã€‚ è€ŒIoC Containeræä¾›äº†åŠ¨æ€åœ°åˆ›å»ºã€æ³¨å…¥ä¾èµ–å•å…ƒï¼Œæ˜ å°„ä¾èµ–å…³ç³»ç­‰åŠŸèƒ½ï¼Œå‡å°‘äº†è®¸å¤šä»£ç é‡ã€‚
  
- æœåŠ¡å®šä½å™¨ï¼ˆService Locatorï¼‰
  
  Service Locatoræ˜¯IoCçš„å¦ä¸€ç§å®ç°æ–¹å¼ï¼Œ å…¶æ ¸å¿ƒæ˜¯æŠŠæ‰€æœ‰å¯èƒ½ç”¨åˆ°çš„ä¾èµ–å•å…ƒäº¤ç”±Service Locatorè¿›è¡Œå®ä¾‹åŒ–å’Œåˆ›å»ºã€é…ç½®ï¼Œ æŠŠç±»å¯¹ä¾èµ–å•å…ƒçš„ä¾èµ–ï¼Œè½¬æ¢æˆç±»å¯¹Service Locatorçš„ä¾èµ–ã€‚ DI ä¸ Service Locatorå¹¶ä¸å†²çªï¼Œä¸¤è€…å¯ä»¥ç»“åˆä½¿ç”¨ã€‚spfä¸­æŠŠè¿™DIå’ŒService Locatorè¿™ä¸¤ä¸ªä¸œè¥¿ç»“åˆèµ·æ¥ä½¿ç”¨ï¼Œæˆ–è€…è¯´é€šè¿‡DIå®¹å™¨ï¼Œå®ç°äº†Service Locatorã€‚



### 8.2 å®¹å™¨çš„è¯ç”Ÿçš„æ•…äº‹

é€šè¿‡ç†è§£é¢å‘å¯¹è±¡å¼€å‘ä¸­ä¾èµ–çš„äº§ç”Ÿå’Œè§£å†³æ–¹æ³•ï¼Œæ¥é€æ¸æ­å¼€â€œä¾èµ–æ³¨å…¥â€çš„é¢çº±ï¼Œé€æ¸ç†è§£è¿™ä¸€ç¥å¥‡çš„è®¾è®¡ç†å¿µã€‚æ•…äº‹è½¬è‡ª [https://www.insp.top/learn-laravel-container](https://www.insp.top/learn-laravel-container)

#### 8.2.1 è¶…äººå’Œè¶…èƒ½åŠ›ï¼Œä¾èµ–çš„äº§ç”Ÿï¼

é¢å‘å¯¹è±¡ç¼–ç¨‹ï¼Œæœ‰ä»¥ä¸‹å‡ æ ·ä¸œè¥¿æ— æ—¶ä¸åˆ»çš„æ¥è§¦ï¼š`æ¥å£`ã€`ç±»`è¿˜æœ‰`å¯¹è±¡`ã€‚è¿™å…¶ä¸­ï¼Œæ¥å£æ˜¯ç±»çš„åŸå‹ï¼Œä¸€ä¸ªç±»å¿…é¡»è¦éµå®ˆå…¶å®ç°çš„æ¥å£ï¼›å¯¹è±¡åˆ™æ˜¯ä¸€ä¸ªç±»å®ä¾‹åŒ–åçš„äº§ç‰©ï¼Œæˆ‘ä»¬ç§°å…¶ä¸ºä¸€ä¸ªå®ä¾‹ã€‚å½“ç„¶è¿™æ ·è¯´è‚¯å®šä¸åˆ©äºç†è§£ï¼Œæˆ‘ä»¬å°±å®é™…çš„å†™ç‚¹ä¸­çœ‹ä¸ä¸­ç”¨çš„ä»£ç è¾…åŠ©å­¦ä¹ ã€‚

> æ€ªç‰©æ¨ªè¡Œçš„ä¸–ç•Œï¼Œæ€»å½’éœ€è¦ç‚¹è¶…çº§äººç‰©æ¥æ‘†å¹³ã€‚

æˆ‘ä»¬æŠŠä¸€ä¸ªâ€œè¶…äººâ€ä½œä¸ºä¸€ä¸ªç±»ï¼Œ

``` javascript
class Superman {}
```

æˆ‘ä»¬å¯ä»¥æƒ³è±¡ï¼Œä¸€ä¸ªè¶…äººè¯ç”Ÿçš„æ—¶å€™è‚¯å®šæ‹¥æœ‰è‡³å°‘ä¸€ä¸ªè¶…èƒ½åŠ›ï¼Œè¿™ä¸ªè¶…èƒ½åŠ›ä¹Ÿå¯ä»¥æŠ½è±¡ä¸ºä¸€ä¸ªå¯¹è±¡ï¼Œä¸ºè¿™ä¸ªå¯¹è±¡å®šä¹‰ä¸€ä¸ªæè¿°ä»–çš„ç±»å§ã€‚ä¸€ä¸ªè¶…èƒ½åŠ›è‚¯å®šæœ‰å¤šç§å±æ€§ã€ï¼ˆæ“ä½œï¼‰æ–¹æ³•ï¼Œè¿™ä¸ªå°½æƒ…çš„æƒ³è±¡ï¼Œä½†æ˜¯ç›®å‰æˆ‘ä»¬å…ˆå¤§è‡´å®šä¹‰ä¸€ä¸ªåªæœ‰å±æ€§çš„â€œè¶…èƒ½åŠ›â€ï¼Œè‡³äºèƒ½å¹²å•¥ï¼Œæˆ‘ä»¬ä»¥åå†ä¸°å¯Œï¼š

``` java
class Power {
    /**
     * èƒ½åŠ›å€¼
     */
    protected $ability;

    /**
     * èƒ½åŠ›èŒƒå›´æˆ–è·ç¦»
     */
    protected $range;

    public function __construct($ability, $range)
    {
        $this->ability = $ability;
        $this->range = $range;
    }
}
```

è¿™æ—¶å€™æˆ‘ä»¬å›è¿‡å¤´ï¼Œä¿®æ”¹ä¸€ä¸‹ä¹‹å‰çš„â€œè¶…äººâ€ç±»ï¼Œè®©ä¸€ä¸ªâ€œè¶…äººâ€åˆ›å»ºçš„æ—¶å€™è¢«èµ‹äºˆä¸€ä¸ªè¶…èƒ½åŠ›ï¼š

``` java
class Superman
{
    protected $power;

    public function __construct()
    {
        $this->power = new Power(999, 100);
    }
}
```

è¿™æ ·çš„è¯ï¼Œå½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªâ€œè¶…äººâ€å®ä¾‹çš„æ—¶å€™ï¼ŒåŒæ—¶ä¹Ÿåˆ›å»ºäº†ä¸€ä¸ªâ€œè¶…èƒ½åŠ›â€çš„å®ä¾‹ï¼Œä½†æ˜¯ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†ä¸€ç‚¹ï¼Œâ€œè¶…äººâ€å’Œâ€œè¶…èƒ½åŠ›â€ä¹‹é—´ä¸å¯é¿å…çš„äº§ç”Ÿäº†ä¸€ä¸ªä¾èµ–ã€‚



> æ‰€è°“â€œä¾èµ–â€ï¼Œå°±æ˜¯ â€œæˆ‘è‹¥ä¾èµ–ä½ ï¼Œæˆ‘å°±ä¸èƒ½ç¦»å¼€ä½ â€ã€‚

åœ¨ä¸€ä¸ªè´¯å½»é¢å‘å¯¹è±¡ç¼–ç¨‹çš„é¡¹ç›®ä¸­ï¼Œè¿™æ ·çš„ä¾èµ–éšå¤„å¯è§ã€‚å°‘é‡çš„ä¾èµ–å¹¶ä¸ä¼šæœ‰å¤ªè¿‡ç›´è§‚çš„å½±å“ï¼Œæˆ‘ä»¬éšç€è¿™ä¸ªä¾‹å­é€æ¸é“ºå¼€ï¼Œè®©å¤§å®¶æ…¢æ…¢æ„è¯†åˆ°ï¼Œå½“ä¾èµ–è¾¾åˆ°ä¸€ä¸ªé‡çº§æ—¶ï¼Œæ˜¯æ€æ ·ä¸€ç•ªå™©æ¢¦èˆ¬çš„ä½“éªŒã€‚å½“ç„¶ï¼Œæˆ‘ä¹Ÿä¼šè‡ªç„¶è€Œç„¶çš„è®²è¿°å¦‚ä½•è§£å†³é—®é¢˜ã€‚

#### 8.2.2 ä¸€å †ä¹±éº» â€”â€” å¯æ€•çš„ä¾èµ–

ä¹‹å‰çš„ä¾‹å­ä¸­ï¼Œè¶…èƒ½åŠ›ç±»å®ä¾‹åŒ–åæ˜¯ä¸€ä¸ªå…·ä½“çš„è¶…èƒ½åŠ›ï¼Œä½†æ˜¯æˆ‘ä»¬çŸ¥é“ï¼Œè¶…äººçš„è¶…èƒ½åŠ›æ˜¯å¤šå…ƒåŒ–çš„ï¼Œæ¯ç§è¶…èƒ½åŠ›çš„æ–¹æ³•ã€å±æ€§éƒ½æœ‰ä¸å°çš„å·®å¼‚ï¼Œæ²¡æ³•é€šè¿‡ä¸€ç§ç±»æè¿°å®Œå…¨ã€‚æˆ‘ä»¬ç°åœ¨è¿›è¡Œä¿®æ”¹ï¼Œæˆ‘ä»¬å‡è®¾è¶…äººå¯ä»¥æœ‰ä»¥ä¸‹å¤šç§è¶…èƒ½åŠ›ï¼š

- é£è¡Œï¼Œå±æ€§æœ‰ï¼šé£è¡Œé€Ÿåº¦ã€æŒç»­é£è¡Œæ—¶é—´
- è›®åŠ›ï¼Œå±æ€§æœ‰ï¼šåŠ›é‡å€¼
- èƒ½é‡å¼¹ï¼Œå±æ€§æœ‰ï¼šä¼¤å®³å€¼ã€å°„å‡»è·ç¦»ã€åŒæ—¶å°„å‡»ä¸ªæ•°

æˆ‘ä»¬åˆ›å»ºäº†å¦‚ä¸‹ç±»ï¼š

``` java
class Flight
{
    protected $speed;
    protected $holdtime;
    public function __construct($speed, $holdtime) {}
}

class Force
{
    protected $force;
    public function __construct($force) {}
}

class Shot
{
    protected $atk;
    protected $range;
    protected $limit;
    public function __construct($atk, $range, $limit) {}
}
```

> ä¸ºäº†çœäº‹å„¿æˆ‘æ²¡æœ‰è¯¦ç»†å†™å‡ºÂ __construct()Â è¿™ä¸ªæ„é€ å‡½æ•°çš„å…¨éƒ¨ï¼Œåªå†™äº†éœ€è¦ä¼ é€’çš„å‚æ•°ã€‚

å¥½äº†ï¼Œè¿™ä¸‹æˆ‘ä»¬çš„è¶…äººæœ‰ç‚¹â€œå¿™â€äº†ã€‚åœ¨è¶…äººåˆå§‹åŒ–çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šæ ¹æ®éœ€è¦æ¥å®ä¾‹åŒ–å…¶æ‹¥æœ‰çš„è¶…èƒ½åŠ›å—ï¼Œå¤§è‡´å¦‚ä¸‹ï¼š

``` java
class Superman
{
    protected $power;

    public function __construct()
    {
        $this->power = new Fight(9, 100);
        // $this->power = new Force(45);
        // $this->power = new Shot(99, 50, 2);
        /*
        $this->power = array(
            new Force(45),
            new Shot(99, 50, 2)
        );
        */
    }
}
```

æˆ‘ä»¬éœ€è¦è‡ªå·±æ‰‹åŠ¨çš„åœ¨æ„é€ å‡½æ•°å†…ï¼ˆæˆ–è€…å…¶ä»–æ–¹æ³•é‡Œï¼‰å®ä¾‹åŒ–ä¸€ç³»åˆ—éœ€è¦çš„ç±»ï¼Œè¿™æ ·å¹¶ä¸å¥½ã€‚å¯ä»¥æƒ³è±¡ï¼Œå‡å¦‚éœ€æ±‚å˜æ›´ï¼ˆä¸åŒçš„æ€ªç‰©æ¨ªè¡Œåœ°çƒï¼‰ï¼Œéœ€è¦æ›´å¤šçš„æœ‰é’ˆå¯¹æ€§çš„Â **æ–°çš„**Â è¶…èƒ½åŠ›ï¼Œæˆ–è€…éœ€è¦Â **å˜æ›´**Â è¶…èƒ½åŠ›çš„æ–¹æ³•ï¼Œæˆ‘ä»¬å¿…é¡»Â `é‡æ–°æ”¹é€ `Â è¶…äººã€‚**æ¢å¥è¯è¯´å°±æ˜¯ï¼Œæ”¹å˜è¶…èƒ½åŠ›çš„åŒæ—¶ï¼Œæˆ‘è¿˜å¾—é‡æ–°åˆ¶é€ ä¸ªè¶…äºº**ã€‚æ•ˆç‡å¤ªä½äº†ï¼æ–°è¶…äººè¿˜æ²¡åˆ›é€ å®Œæˆä¸–ç•Œæ—©å·²è¢«æ¯ç­ã€‚

> è¿™æ—¶ï¼Œçµæœºä¸€åŠ¨çš„äººæƒ³åˆ°ï¼šä¸ºä»€ä¹ˆä¸å¯ä»¥è¿™æ ·å‘¢ï¼Ÿè¶…äººçš„èƒ½åŠ›å¯ä»¥è¢«éšæ—¶æ›´æ¢ï¼Œåªéœ€è¦æ·»åŠ æˆ–è€…æ›´æ–°ä¸€ä¸ªèŠ¯ç‰‡æˆ–è€…å…¶ä»–è£…ç½®å•¥çš„ï¼ˆæƒ³åˆ°é’¢é“ä¾ æ²¡ï¼‰ã€‚è¿™æ ·çš„è¯å°±ä¸è¦æ•´ä¸ªé‡æ–°æ¥è¿‡äº†ã€‚

å¯¹ï¼Œå°±æ˜¯è¿™æ ·çš„ã€‚

æˆ‘ä»¬ä¸åº”è¯¥æ‰‹åŠ¨åœ¨ â€œè¶…äººâ€ ç±»ä¸­å›ºåŒ–äº†ä»–çš„ â€œè¶…èƒ½åŠ›â€ åˆå§‹åŒ–çš„è¡Œä¸ºï¼Œè€Œè½¬ç”±å¤–éƒ¨è´Ÿè´£ï¼Œç”±å¤–éƒ¨åˆ›é€ è¶…èƒ½åŠ›æ¨¡ç»„ã€è£…ç½®æˆ–è€…èŠ¯ç‰‡ç­‰ï¼ˆæˆ‘ä»¬åé¢ç»Ÿä¸€ç§°ä¸º â€œæ¨¡ç»„â€ï¼‰ï¼Œæ¤å…¥è¶…äººä½“å†…çš„æŸä¸€ä¸ªæ¥å£ï¼Œè¿™ä¸ªæ¥å£æ˜¯ä¸€ä¸ªæ—¢å®šçš„ï¼Œåªè¦è¿™ä¸ª â€œæ¨¡ç»„â€ æ»¡è¶³è¿™ä¸ªæ¥å£çš„è£…ç½®éƒ½å¯ä»¥è¢«è¶…äººæ‰€åˆ©ç”¨ï¼Œå¯ä»¥æå‡ã€å¢åŠ è¶…äººçš„æŸä¸€ç§èƒ½åŠ›ã€‚è¿™ç§ç”±å¤–éƒ¨è´Ÿè´£å…¶ä¾èµ–éœ€æ±‚çš„è¡Œä¸ºï¼Œæˆ‘ä»¬å¯ä»¥ç§°å…¶ä¸º â€œ`æ§åˆ¶åè½¬ï¼ˆIoCï¼‰`â€ã€‚

#### 8.2.3 å·¥å‚æ¨¡å¼ï¼Œä¾èµ–è½¬ç§»ï¼

å½“ç„¶ï¼Œå®ç°æ§åˆ¶åè½¬çš„æ–¹æ³•æœ‰å‡ ç§ã€‚åœ¨è¿™ä¹‹å‰ï¼Œä¸å¦‚æˆ‘ä»¬å…ˆäº†è§£ä¸€äº›å¥½ç©çš„ä¸œè¥¿ã€‚

> æˆ‘ä»¬å¯ä»¥æƒ³åˆ°ï¼Œç»„ä»¶ã€å·¥å…·ï¼ˆæˆ–è€…è¶…äººçš„æ¨¡ç»„ï¼‰ï¼Œæ˜¯ä¸€ç§å¯è¢«ç”Ÿäº§çš„ç©æ„å„¿ï¼Œç”Ÿäº§çš„åœ°æ–¹å½“ç„¶æ˜¯ â€œå·¥å‚ï¼ˆFactoryï¼‰â€ï¼Œäºæ˜¯æœ‰äººå°±æå‡ºäº†è¿™æ ·ä¸€ç§æ¨¡å¼ï¼šÂ `å·¥å‚æ¨¡å¼`ã€‚

å·¥å‚æ¨¡å¼ï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯ä¸€ä¸ªç±»æ‰€ä¾èµ–çš„å¤–éƒ¨äº‹ç‰©çš„å®ä¾‹ï¼Œéƒ½å¯ä»¥è¢«ä¸€ä¸ªæˆ–å¤šä¸ª â€œå·¥å‚â€ åˆ›å»ºçš„è¿™æ ·ä¸€ç§å¼€å‘æ¨¡å¼ï¼Œå°±æ˜¯ â€œ`å·¥å‚æ¨¡å¼`â€ã€‚

æˆ‘ä»¬ä¸ºäº†ç»™è¶…äººåˆ¶é€ è¶…èƒ½åŠ›æ¨¡ç»„ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªå·¥å‚ï¼Œå®ƒå¯ä»¥åˆ¶é€ å„ç§å„æ ·çš„æ¨¡ç»„ï¼Œä¸”ä»…éœ€è¦é€šè¿‡ä¸€ä¸ªæ–¹æ³•ï¼š

``` java
class SuperModuleFactory
{
    public function makeModule($moduleName, $options)
    {
        switch ($moduleName) {
            case 'Fight':   return new Fight($options[0], $options[1]);
            case 'Force':   return new Force($options[0]);
            case 'Shot':    return new Shot($options[0], $options[1], $options[2]);
        }
    }
}
```

è¿™æ—¶å€™ï¼Œè¶…äºº åˆ›å»ºä¹‹åˆå°±å¯ä»¥ä½¿ç”¨è¿™ä¸ªå·¥å‚ï¼

``` java
class Superman
{
    protected $power;

    public function __construct()
    {
        // åˆå§‹åŒ–å·¥å‚
        $factory = new SuperModuleFactory;

        // é€šè¿‡å·¥å‚æä¾›çš„æ–¹æ³•åˆ¶é€ éœ€è¦çš„æ¨¡å—
        $this->power = $factory->makeModule('Fight', [9, 100]);
        // $this->power = $factory->makeModule('Force', [45]);
        // $this->power = $factory->makeModule('Shot', [99, 50, 2]);
        /*
        $this->power = array(
            $factory->makeModule('Force', [45]),
            $factory->makeModule('Shot', [99, 50, 2])
        );
        */
    }
}
```

å¯ä»¥çœ‹å¾—å‡ºï¼Œæˆ‘ä»¬ä¸å†éœ€è¦åœ¨è¶…äººåˆå§‹åŒ–ä¹‹åˆï¼Œå»åˆå§‹åŒ–è®¸å¤šç¬¬ä¸‰æ–¹ç±»ï¼Œåªéœ€åˆå§‹åŒ–ä¸€ä¸ªå·¥å‚ç±»ï¼Œå³å¯æ»¡è¶³éœ€æ±‚ã€‚ä½†è¿™æ ·ä¼¼ä¹å’Œä»¥å‰åŒºåˆ«ä¸å¤§ï¼Œåªæ˜¯æ²¡æœ‰é‚£ä¹ˆå¤šÂ `new`Â å…³é”®å­—ã€‚å…¶å®æˆ‘ä»¬ç¨å¾®æ”¹é€ ä¸€ä¸‹è¿™ä¸ªç±»ï¼Œä½ å°±æ˜ç™½ï¼Œå·¥å‚ç±»çš„çœŸæ­£æ„ä¹‰å’Œä»·å€¼äº†ã€‚

``` java
class Superman
{
    protected $power;

    public function __construct(array $modules)
    {
        // åˆå§‹åŒ–å·¥å‚
        $factory = new SuperModuleFactory;
        // é€šè¿‡å·¥å‚æä¾›çš„æ–¹æ³•åˆ¶é€ éœ€è¦çš„æ¨¡å—
        foreach ($modules as $moduleName => $moduleOptions) {
            $this->power[] = $factory->makeModule($moduleName, $moduleOptions);
        }
    }
}

// åˆ›å»ºè¶…äºº
$superman = new Superman([
    'Fight' => [9, 100], 
    'Shot' => [99, 50, 2]
]);
```

ç°åœ¨ä¿®æ”¹çš„ç»“æœä»¤äººæ»¡æ„ã€‚ç°åœ¨ï¼Œâ€œè¶…äººâ€ çš„åˆ›å»ºä¸å†ä¾èµ–ä»»ä½•ä¸€ä¸ª â€œè¶…èƒ½åŠ›â€ çš„ç±»ï¼Œæˆ‘ä»¬å¦‚è‹¥ä¿®æ”¹äº†æˆ–è€…å¢åŠ äº†æ–°çš„è¶…èƒ½åŠ›ï¼Œåªéœ€è¦é’ˆå¯¹ä¿®æ”¹Â `SuperModuleFactory`Â å³å¯ã€‚æ‰©å……è¶…èƒ½åŠ›çš„åŒæ—¶ä¸å†éœ€è¦é‡æ–°ç¼–è¾‘è¶…äººçš„ç±»æ–‡ä»¶ï¼Œä½¿å¾—æˆ‘ä»¬å˜å¾—å¾ˆè½»æ¾ã€‚ä½†æ˜¯ï¼Œè¿™æ‰åˆšåˆšå¼€å§‹ã€‚

#### 8.2.4 å†è¿›ä¸€æ­¥ï¼IoC å®¹å™¨çš„é‡è¦ç»„æˆ â€”â€” ä¾èµ–æ³¨å…¥ï¼

ç”± â€œè¶…äººâ€ å¯¹ â€œè¶…èƒ½åŠ›â€ çš„ä¾èµ–å˜æˆ â€œè¶…äººâ€ å¯¹ â€œè¶…èƒ½åŠ›æ¨¡ç»„å·¥å‚â€ çš„ä¾èµ–åï¼Œå¯¹ä»˜å°æ€ªå…½ä»¬å˜å¾—æ›´åŠ å¾—å¿ƒåº”æ‰‹ã€‚ä½†è¿™ä¹Ÿæ­£å¦‚ä½ æ‰€çœ‹åˆ°çš„ï¼Œä¾èµ–å¹¶æœªè§£é™¤ï¼Œåªæ˜¯ç”±åŸæ¥å¯¹å¤šä¸ªå¤–éƒ¨çš„ä¾èµ–å˜æˆäº†å¯¹ä¸€ä¸ª â€œå·¥å‚â€ çš„ä¾èµ–ã€‚å‡å¦‚å·¥å‚å‡ºäº†ç‚¹éº»çƒ¦ï¼Œé—®é¢˜å˜å¾—å°±å¾ˆæ£˜æ‰‹ã€‚

> å…¶å®å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå·¥å‚æ¨¡å¼å·²ç»è¶³å¤Ÿäº†ã€‚å·¥å‚æ¨¡å¼çš„ç¼ºç‚¹å°±æ˜¯ï¼šæ¥å£æœªçŸ¥ï¼ˆå³æ²¡æœ‰ä¸€ä¸ªå¾ˆå¥½çš„å¥‘çº¦æ¨¡å‹ï¼Œå…³äºè¿™ä¸ªæˆ‘é©¬ä¸Šä¼šæœ‰è§£é‡Šï¼‰ã€äº§ç”Ÿå¯¹è±¡ç±»å‹å•ä¸€ã€‚æ€»ä¹‹å°±æ˜¯ï¼Œè¿˜æ˜¯ä¸å¤Ÿçµæ´»ã€‚è™½ç„¶å¦‚æ­¤ï¼Œå·¥å‚æ¨¡å¼ä¾æ—§ååˆ†ä¼˜ç§€ï¼Œå¹¶ä¸”é€‚ç”¨äºç»å¤§å¤šæ•°æƒ…å†µã€‚ä¸è¿‡æˆ‘ä»¬ä¸ºäº†è®²è§£åé¢çš„Â `ä¾èµ–æ³¨å…¥`Â ï¼Œè¿™é‡Œå°±å…ˆå¤¸å¤§ä¸€ä¸‹å·¥å‚æ¨¡å¼çš„ç¼ºé™·å’¯ã€‚

æˆ‘ä»¬çŸ¥é“ï¼Œè¶…äººä¾èµ–çš„æ¨¡ç»„ï¼Œæˆ‘ä»¬è¦æ±‚æœ‰ç»Ÿä¸€çš„æ¥å£ï¼Œè¿™æ ·æ‰èƒ½å’Œè¶…äººèº«ä¸Šçš„æ³¨å…¥æ¥å£å¯¹æ¥ï¼Œæœ€ç»ˆèµ·åˆ°æå‡è¶…èƒ½åŠ›çš„æ•ˆæœã€‚

äº‹å®ä¸Šï¼Œæˆ‘ä¹‹å‰è¯´è°äº†ï¼Œä¸ä»…ä»…åªæœ‰ä¸€å †å°æ€ªå…½ï¼Œè¿˜æœ‰æ›´å¤šçš„å¤§æ€ªå…½ã€‚å˜¿å˜¿ã€‚é¢ï¼Œè¿™æ—¶å€™ä¼¼ä¹å·¥å‚çš„ç”Ÿäº§èƒ½åŠ›æ˜¾å¾—æœ‰äº›ä¸è¶³ â€”â€” ç”±äºå·¥å‚æ¨¡å¼ä¸‹ï¼Œæ‰€æœ‰çš„æ¨¡ç»„éƒ½å·²ç»åœ¨å·¥å‚ç±»ä¸­å®‰æ’å¥½äº†ï¼Œå¦‚æœæœ‰æ–°çš„ã€é«˜çº§çš„æ¨¡ç»„åŠ å…¥ï¼Œæˆ‘ä»¬å¿…é¡»ä¿®æ”¹å·¥å‚ç±»ï¼ˆå¥½æ¯”å¢åŠ æ–°çš„ç”Ÿäº§çº¿ï¼‰ï¼š

``` java
class SuperModuleFactory
{
    public function makeModule($moduleName, $options)
    {
        switch ($moduleName) {
            case 'Fight':   return new Fight($options[0], $options[1]);
            case 'Force':   return new Force($options[0]);
            case 'Shot':    return new Shot($options[0], $options[1], $options[2]);
            // case 'more': .......
            // case 'and more': .......
            // case 'and more': .......
            // case 'oh no! its too many!': .......
        }
    }
}
```

çœ‹åˆ°æ²¡ã€‚ã€‚ã€‚å™©æ¢¦èˆ¬çš„æ„Ÿå—ï¼

> å…¶å®çµæ„Ÿå°±å·®ä¸€æ­¥ï¼ä½ å¯èƒ½ä¼šæƒ³åˆ°æ›´ä¸ºçµæ´»çš„åŠæ³•ï¼å¯¹ï¼Œä¸‹ä¸€æ­¥å°±æ˜¯æˆ‘ä»¬ä»Šå¤©çš„ä¸»è¦é…è§’ â€”â€” DI ï¼ˆä¾èµ–æ³¨å…¥ï¼‰

ç”±äºå¯¹è¶…èƒ½åŠ›æ¨¡ç»„çš„éœ€æ±‚ä¸æ–­å¢å¤§ï¼Œæˆ‘ä»¬éœ€è¦é›†åˆæ•´ä¸ªä¸–ç•Œçš„é«˜æ™ºå•†äººæ‰ï¼Œä¸€èµ·è§£å†³é—®é¢˜ï¼Œä¸åº”è¯¥ä»…ä»…åªæœ‰å‡ ä¸ªå·¥å‚å„æ–­è´Ÿè´£ã€‚ä¸è¿‡é«˜æ™ºå•†äººæ‰ä»¬éƒ½éå¸¸è‡ªè´Ÿï¼Œè®¤ä¸ºè‡ªå·±çš„æƒ³æ³•æ˜¯å¯¹çš„ï¼Œåˆ›é€ å‡ºçš„è¶…èƒ½åŠ›æ¨¡ç»„æ²¡æœ‰ç»Ÿä¸€çš„æ¥å£ï¼Œè‡ªç„¶è€Œç„¶æ— æ³•è¢«æ­£å¸¸ä½¿ç”¨ã€‚è¿™æ—¶æˆ‘ä»¬éœ€è¦æå‡ºä¸€ç§å¥‘çº¦ï¼Œè¿™æ ·æ— è®ºæ˜¯è°åˆ›é€ å‡ºçš„æ¨¡ç»„ï¼Œéƒ½ç¬¦åˆè¿™æ ·çš„æ¥å£ï¼Œè‡ªç„¶å°±å¯è¢«æ­£å¸¸ä½¿ç”¨ã€‚

``` java
interface SuperModuleInterface
{
    /**
     * è¶…èƒ½åŠ›æ¿€æ´»æ–¹æ³•
     *
     * ä»»ä½•ä¸€ä¸ªè¶…èƒ½åŠ›éƒ½å¾—æœ‰è¯¥æ–¹æ³•ï¼Œå¹¶æ‹¥æœ‰ä¸€ä¸ªå‚æ•°
     *@param array $target é’ˆå¯¹ç›®æ ‡ï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªï¼Œè‡ªå·±æˆ–ä»–äºº
     */
    public function activate(array $target);
}
```

> ä¸Šæ–‡ä¸­ï¼Œæˆ‘ä»¬å®šä¸‹äº†ä¸€ä¸ªæ¥å£ ï¼ˆè¶…èƒ½åŠ›æ¨¡ç»„çš„è§„èŒƒã€å¥‘çº¦ï¼‰ï¼Œæ‰€æœ‰è¢«åˆ›é€ çš„æ¨¡ç»„å¿…é¡»éµå®ˆè¯¥è§„èŒƒï¼Œæ‰èƒ½è¢«ç”Ÿäº§ã€‚
> 
> å…¶å®ï¼Œè¿™å°±æ˜¯ php ä¸­Â `æ¥å£ï¼ˆ interface ï¼‰`Â çš„ç”¨å¤„å’Œæ„ä¹‰ï¼å¾ˆå¤šäººè§‰å¾—ï¼Œä¸ºä»€ä¹ˆ php éœ€è¦æ¥å£è¿™ç§ä¸œè¥¿ï¼Ÿéš¾é“ä¸æ˜¯ java ã€ C# ä¹‹ç±»çš„è¯­è¨€æ‰æœ‰çš„å—ï¼Ÿè¿™ä¹ˆè¯´ï¼Œåªè¦æ˜¯ä¸€ä¸ªæ­£å¸¸çš„é¢å‘å¯¹è±¡ç¼–ç¨‹è¯­è¨€ï¼ˆè™½ç„¶ php å¯ä»¥é¢å‘è¿‡ç¨‹ï¼‰ï¼Œéƒ½åº”è¯¥å…·å¤‡è¿™ä¸€ç‰¹æ€§ã€‚å› ä¸ºä¸€ä¸ªÂ `å¯¹è±¡ï¼ˆobjectï¼‰`Â æœ¬èº«æ˜¯ç”±ä»–çš„æ¨¡æ¿æˆ–è€…åŸå‹ â€”â€”Â `ç±» ï¼ˆclassï¼‰`Â ï¼Œç»è¿‡å®ä¾‹åŒ–åäº§ç”Ÿçš„ä¸€ä¸ªå…·ä½“äº‹ç‰©ï¼Œè€Œæœ‰æ—¶å€™ï¼Œå®ç°ç»Ÿä¸€ç§æ–¹æ³•ä¸”ä¸åŒåŠŸèƒ½ï¼ˆæˆ–ç‰¹æ€§ï¼‰çš„æ—¶å€™ï¼Œä¼šå­˜åœ¨å¾ˆå¤šçš„ç±»ï¼ˆclassï¼‰ï¼Œè¿™æ—¶å€™å°±éœ€è¦æœ‰ä¸€ä¸ªå¥‘çº¦ï¼Œè®©å¤§å®¶ç¼–å†™å‡ºå¯ä»¥è¢«éšæ—¶æ›¿æ¢å´ä¸ä¼šäº§ç”Ÿå½±å“çš„æ¥å£ã€‚è¿™ç§ç”±ç¼–ç¨‹è¯­è¨€æœ¬èº«æå‡ºçš„ç¡¬æ€§è§„èŒƒï¼Œä¼šå¢åŠ æ›´å¤šä¼˜ç§€çš„ç‰¹æ€§ã€‚
> 
> è™½ç„¶æœ‰äº›ç»•ï¼Œä½†é€šè¿‡æˆ‘ä»¬æ¥ä¸‹æ¥çš„å®ä¾‹ï¼Œå¤§å®¶ä¼šæ…¢æ…¢é¢†ä¼šæ¥å£å¸¦æ¥çš„å¥½å¤„ã€‚

è¿™æ—¶å€™ï¼Œé‚£äº›æå‡ºæ›´å¥½çš„è¶…èƒ½åŠ›æ¨¡ç»„çš„é«˜æ™ºå•†äººæ‰ï¼Œéµå¾ªè¿™ä¸ªæ¥å£ï¼Œåˆ›å»ºäº†ä¸‹è¿°ï¼ˆæ¨¡ç»„ï¼‰ç±»ï¼š

``` java
/**
 * X-è¶…èƒ½é‡
 */
class XPower implements SuperModuleInterface
{
    public function activate(array $target)
    {
        // è¿™åªæ˜¯ä¸ªä¾‹å­ã€‚ã€‚å…·ä½“è‡ªè¡Œè„‘è¡¥
    }
}

/**
 * ç»ˆæç‚¸å¼¹ ï¼ˆå°±è¿™ä¹ˆä¿—ï¼‰
 */
class UltraBomb implements SuperModuleInterface
{
    public function activate(array $target)
    {
        // è¿™åªæ˜¯ä¸ªä¾‹å­ã€‚ã€‚å…·ä½“è‡ªè¡Œè„‘è¡¥
    }
}
```

åŒæ—¶ï¼Œä¸ºäº†é˜²æ­¢æœ‰äº› â€œç –å®¶â€ è‡ªä½œèªæ˜ï¼Œæˆ–è€…ä¸€äº›å›å¾’æ¶æ„æ£è›‹ï¼Œä¸éµå®ˆå¥‘çº¦èƒ¡ä¹±åˆ¶é€ æ¨¡ç»„ï¼Œå½±å“è¶…äººï¼Œæˆ‘ä»¬å¯¹è¶…äººåˆå§‹åŒ–çš„æ–¹æ³•è¿›è¡Œæ”¹é€ ï¼š

``` java
class Superman
{
    protected $module;

    public function __construct(SuperModuleInterface $module)
    {
        $this->module = $module
    }
}
```

æ”¹é€ å®Œæ¯•ï¼ç°åœ¨ï¼Œå½“æˆ‘ä»¬åˆå§‹åŒ– â€œè¶…äººâ€ ç±»çš„æ—¶å€™ï¼Œæä¾›çš„æ¨¡ç»„å®ä¾‹å¿…é¡»æ˜¯ä¸€ä¸ª`SuperModuleInterface`Â æ¥å£çš„å®ç°ã€‚å¦åˆ™å°±ä¼šæç¤ºé”™è¯¯ã€‚

æ­£æ˜¯ç”±äºè¶…äººçš„åˆ›é€ å˜å¾—å®¹æ˜“ï¼Œä¸€ä¸ªè¶…äººä¹Ÿå°±ä¸éœ€è¦å¤ªå¤šçš„è¶…èƒ½åŠ›ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›é€ å¤šä¸ªè¶…äººï¼Œå¹¶åˆ†åˆ«æ³¨å…¥éœ€è¦çš„è¶…èƒ½åŠ›æ¨¡ç»„å³å¯ã€‚è¿™æ ·çš„è¯ï¼Œè™½ç„¶ä¸€ä¸ªè¶…äººåªæœ‰ä¸€ä¸ªè¶…èƒ½åŠ›ï¼Œä½†è¶…äººæ›´å®¹æ˜“å˜å¤šï¼Œæˆ‘ä»¬ä¹Ÿä¸æ€•æ€ªå…½å•¦ï¼

> ç°åœ¨æœ‰äººç–‘æƒ‘äº†ï¼Œä½ è¦è®²çš„Â `ä¾èµ–æ³¨å…¥`Â å‘¢ï¼Ÿ
> 
> å…¶å®ï¼Œä¸Šé¢è®²çš„å†…å®¹ï¼Œæ­£æ˜¯ä¾èµ–æ³¨å…¥ã€‚

ä»€ä¹ˆå«åšÂ `ä¾èµ–æ³¨å…¥`ï¼Ÿ

æœ¬æ–‡ä»å¼€å¤´åˆ°ç°åœ¨æåˆ°çš„ä¸€ç³»åˆ—ä¾èµ–ï¼Œåªè¦ä¸æ˜¯ç”±å†…éƒ¨ç”Ÿäº§ï¼ˆæ¯”å¦‚åˆå§‹åŒ–ã€æ„é€ å‡½æ•°`__construct`Â ä¸­é€šè¿‡å·¥å‚æ–¹æ³•ã€è‡ªè¡Œæ‰‹åŠ¨ new çš„ï¼‰ï¼Œè€Œæ˜¯ç”±å¤–éƒ¨ä»¥å‚æ•°æˆ–å…¶ä»–å½¢å¼æ³¨å…¥çš„ï¼Œéƒ½å±äºÂ `ä¾èµ–æ³¨å…¥ï¼ˆDIï¼‰`Â ã€‚æ˜¯ä¸æ˜¯è±ç„¶å¼€æœ—ï¼Ÿäº‹å®ä¸Šï¼Œå°±æ˜¯è¿™ä¹ˆç®€å•ã€‚ä¸‹é¢å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„ä¾èµ–æ³¨å…¥ï¼š

``` java
// è¶…èƒ½åŠ›æ¨¡ç»„
$superModule = new XPower;
// åˆå§‹åŒ–ä¸€ä¸ªè¶…äººï¼Œå¹¶æ³¨å…¥ä¸€ä¸ªè¶…èƒ½åŠ›æ¨¡ç»„ä¾èµ–
$superMan = new Superman($superModule);
```

å…³äºä¾èµ–æ³¨å…¥è¿™ä¸ªæœ¬æ–‡çš„ä¸»è¦é…è§’ï¼Œä¹Ÿå°±è¿™ä¹ˆå¤šéœ€è¦è®²çš„ã€‚ç†è§£äº†ä¾èµ–æ³¨å…¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç»§ç»­æ·±å…¥é—®é¢˜ã€‚æ…¢æ…¢èµ°è¿‘ä»Šå¤©çš„ä¸»è§’â€¦â€¦

#### 8.2.5 æ›´ä¸ºå…ˆè¿›çš„å·¥å‚ â€”â€” IoC å®¹å™¨ï¼

åˆšåˆšåˆ—äº†ä¸€æ®µä»£ç ï¼š

``` java
$superModule = new XPower;
$superMan = new Superman($superModule);
```

è¯»è€…åº”è¯¥çœ‹å‡ºæ¥äº†ï¼Œæ‰‹åŠ¨çš„åˆ›å»ºäº†ä¸€ä¸ªè¶…èƒ½åŠ›æ¨¡ç»„ã€æ‰‹åŠ¨çš„åˆ›å»ºè¶…äººå¹¶æ³¨å…¥äº†åˆšåˆšåˆ›å»ºè¶…èƒ½åŠ›æ¨¡ç»„ã€‚å‘µå‘µï¼Œæ‰‹åŠ¨ã€‚

> ç°ä»£ç¤¾ä¼šï¼Œåº”è¯¥æ˜¯é«˜æ•ˆç‡çš„ç”Ÿäº§ï¼Œå¹²å‡€çš„è½¦é—´ï¼Œå®Œç¾çš„è‡ªåŠ¨åŒ–è£…é…ã€‚

ä¸€ç¾¤æ€ªå…½æ¥äº†ï¼Œå¦‚æ­¤ä½æ•ˆç‡äº§å‡ºè¶…äººæ˜¯ä¸ç°å®ï¼Œæˆ‘ä»¬éœ€è¦è‡ªåŠ¨åŒ– â€”â€” æœ€å¤šä¸€æ¡æŒ‡ä»¤ï¼Œåƒå†›ä¸‡é©¬æ¥ç›¸è§ã€‚æˆ‘ä»¬éœ€è¦ä¸€ç§é«˜çº§çš„ç”Ÿäº§è½¦é—´ï¼Œæˆ‘ä»¬åªéœ€è¦å‘ç”Ÿäº§è½¦é—´æäº¤ä¸€ä¸ªè„šæœ¬ï¼Œå·¥å‚ä¾¿èƒ½å¤Ÿé€šè¿‡æŒ‡ä»¤è‡ªåŠ¨åŒ–ç”Ÿäº§ã€‚è¿™ç§æ›´ä¸ºé«˜çº§çš„å·¥å‚ï¼Œå°±æ˜¯å·¥å‚æ¨¡å¼çš„å‡å â€”â€”Â `IoC å®¹å™¨`ã€‚

``` java
class Container
{
    protected $binds;
    protected $instances;
    public function bind($abstract, $concrete)
    {
        if ($concrete instanceof Closure) {
            $this->binds[$abstract] = $concrete;
        } else {
            $this->instances[$abstract] = $concrete;
        }
    }
    public function make($abstract, $parameters = [])
    {
        if (isset($this->instances[$abstract])) {
            return $this->instances[$abstract];
        }
        array_unshift($parameters, $this);
        return call_user_func_array($this->binds[$abstract], $parameters);
    }
}
```

è¿™æ—¶å€™ï¼Œä¸€ä¸ªååˆ†ç²—ç³™çš„å®¹å™¨å°±è¯ç”Ÿäº†ã€‚ç°åœ¨çš„ç¡®å¾ˆç®€é™‹ï¼Œä½†ä¸å¦¨ç¢æˆ‘ä»¬è¿›ä¸€æ­¥æå‡ä»–ã€‚å…ˆç€çœ¼ç°åœ¨ï¼Œçœ‹çœ‹è¿™ä¸ªå®¹å™¨å¦‚ä½•ä½¿ç”¨å§ï¼

``` javascript
// åˆ›å»ºä¸€ä¸ªå®¹å™¨ï¼ˆåé¢ç§°ä½œè¶…çº§å·¥å‚ï¼‰
$container = new Container;

// å‘è¯¥ è¶…çº§å·¥å‚ æ·»åŠ  è¶…äºº çš„ç”Ÿäº§è„šæœ¬
$container->bind('superman', function($container, $moduleName) {
    return new Superman($container->make($moduleName));
});

// å‘è¯¥ è¶…çº§å·¥å‚ æ·»åŠ  è¶…èƒ½åŠ›æ¨¡ç»„ çš„ç”Ÿäº§è„šæœ¬
$container->bind('xpower', function($container) {
    return new XPower;
});

// åŒä¸Š
$container->bind('ultrabomb', function($container) {
    return new UltraBomb;
});

// ******************  åä¸½ä¸½çš„åˆ†å‰²çº¿  **********************
// å¼€å§‹å¯åŠ¨ç”Ÿäº§
$superman_1 = $container->make('superman', ['xpower']);
$superman_2 = $container->make('superman', ['ultrabomb']);
$superman_3 = $container->make('superman', ['xpower']);
// ...éšæ„æ·»åŠ 
```

çœ‹åˆ°æ²¡ï¼Ÿé€šè¿‡æœ€åˆçš„Â `ç»‘å®šï¼ˆbindï¼‰`Â æ“ä½œï¼Œæˆ‘ä»¬å‘ è¶…çº§å·¥å‚ æ³¨å†Œäº†ä¸€äº›ç”Ÿäº§è„šæœ¬ï¼Œè¿™äº›ç”Ÿäº§è„šæœ¬åœ¨ç”Ÿäº§æŒ‡ä»¤ä¸‹è¾¾ä¹‹æ—¶ä¾¿ä¼šæ‰§è¡Œã€‚å‘ç°æ²¡æœ‰ï¼Ÿæˆ‘ä»¬å½»åº•çš„è§£é™¤äº† è¶…äºº ä¸ è¶…èƒ½åŠ›æ¨¡ç»„ çš„ä¾èµ–å…³ç³»ï¼Œæ›´é‡è¦çš„æ˜¯ï¼Œå®¹å™¨ç±»ä¹Ÿä¸æ¯«æ²¡æœ‰å’Œä»–ä»¬äº§ç”Ÿä»»ä½•ä¾èµ–ï¼æˆ‘ä»¬é€šè¿‡æ³¨å†Œã€ç»‘å®šçš„æ–¹å¼å‘å®¹å™¨ä¸­æ·»åŠ ä¸€æ®µå¯ä»¥è¢«æ‰§è¡Œçš„å›è°ƒï¼ˆå¯ä»¥æ˜¯åŒ¿åå‡½æ•°ã€éåŒ¿åå‡½æ•°ã€ç±»çš„æ–¹æ³•ï¼‰ä½œä¸ºç”Ÿäº§ä¸€ä¸ªç±»çš„å®ä¾‹çš„Â **è„šæœ¬**Â ï¼Œåªæœ‰åœ¨çœŸæ­£çš„Â `ç”Ÿäº§ï¼ˆmakeï¼‰`Â æ“ä½œè¢«è°ƒç”¨æ‰§è¡Œæ—¶ï¼Œæ‰ä¼šè§¦å‘ã€‚

è¿™æ ·ä¸€ç§æ–¹å¼ï¼Œä½¿å¾—æˆ‘ä»¬æ›´å®¹æ˜“åœ¨åˆ›å»ºä¸€ä¸ªå®ä¾‹çš„åŒæ—¶è§£å†³å…¶ä¾èµ–å…³ç³»ï¼Œå¹¶ä¸”æ›´åŠ çµæ´»ã€‚å½“æœ‰æ–°çš„éœ€æ±‚ï¼Œåªéœ€å¦å¤–ç»‘å®šä¸€ä¸ªâ€œç”Ÿäº§è„šæœ¬â€å³å¯ã€‚

> å®é™…ä¸Šï¼ŒçœŸæ­£çš„ IoC å®¹å™¨æ›´ä¸ºé«˜çº§ã€‚æˆ‘ä»¬ç°åœ¨çš„ä¾‹å­ä¸­ï¼Œè¿˜æ˜¯éœ€è¦æ‰‹åŠ¨æä¾›è¶…äººæ‰€éœ€è¦çš„æ¨¡ç»„å‚æ•°ï¼Œä½†çœŸæ­£çš„ IoC å®¹å™¨ä¼šæ ¹æ®ç±»çš„ä¾èµ–éœ€æ±‚ï¼Œè‡ªåŠ¨åœ¨æ³¨å†Œã€ç»‘å®šçš„ä¸€å †å®ä¾‹ä¸­æœå¯»ç¬¦åˆçš„ä¾èµ–éœ€æ±‚ï¼Œå¹¶è‡ªåŠ¨æ³¨å…¥åˆ°æ„é€ å‡½æ•°å‚æ•°ä¸­å»ã€‚Laravel æ¡†æ¶çš„æœåŠ¡å®¹å™¨æ­£æ˜¯è¿™ä¹ˆåšçš„ã€‚å®ç°è¿™ç§åŠŸèƒ½å…¶å®ç†è®ºä¸Šå¹¶ä¸éº»çƒ¦ï¼Œä½†æˆ‘å¹¶ä¸ä¼šåœ¨æœ¬æ–‡ä¸­å†™å‡ºï¼Œå› ä¸ºâ€¦â€¦æˆ‘æ‡’å¾—å†™ã€‚
> 
> ä¸è¿‡æˆ‘å‘Šè¯‰å¤§å®¶ï¼Œè¿™ç§è‡ªåŠ¨æœå¯»ä¾èµ–éœ€æ±‚çš„åŠŸèƒ½ï¼Œæ˜¯é€šè¿‡Â `åå°„ï¼ˆReflectionï¼‰`Â å®ç°çš„ï¼Œæ°å¥½çš„ï¼Œphp å®Œç¾çš„æ”¯æŒåå°„æœºåˆ¶ï¼å…³äºåå°„ï¼Œphp å®˜æ–¹æ–‡æ¡£æœ‰è¯¦ç»†çš„èµ„æ–™ï¼Œå¹¶ä¸”ä¸­æ–‡ç¿»è¯‘åŸºæœ¬è¦†ç›–ï¼Œè¶³å¤Ÿå­¦ä¹ å’Œç ”ç©¶ï¼
> 
> [http://php.net/manual/zh/book.reflection.php](http://php.net/manual/zh/book.reflection.php)

ç°åœ¨ï¼Œåˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»ä¸å†æƒ§æ€•æ€ªå…½ä»¬äº†ã€‚é«˜æ™ºå•†äººæ‰é›†æ€å¹¿ç›Šï¼Œäº•äº•æœ‰æ¡ï¼Œæ ¹æ®æ¥å£å¥‘çº¦åˆ›é€ è§„èŒƒçš„è¶…èƒ½åŠ›æ¨¡ç»„ã€‚è¶…äººå¼€å§‹æ‰¹é‡äº§å‡ºã€‚æœ€ç»ˆï¼Œäººäººéƒ½æ˜¯è¶…äººï¼Œä½ ä¹Ÿå¯ä»¥æ˜¯å“¦Â ğŸ˜€ï¼



### 8.3 SPFå®¹å™¨çš„ä½¿ç”¨æ–¹æ³•



#### 8.3.1 åˆ›å»ºå®¹å™¨

``` java
use spf\Container\Container;
$container = new Container();
```

#### 8.3.2 æ·»åŠ å˜é‡æˆ–å¯¹è±¡åˆ°å®¹å™¨

``` javascript
//æ·»åŠ å¯¹è±¡
$container['router'] = new Router();
//æ·»åŠ æ•°ç»„
$container['dbconfig'] = [
    'bbs_db' => [
      'host'=>'127.0.0.1',
      'port'=>3306,
      'usr'=>'root',
      'password'=>'***',
      'database'=>'socialdb',
    ],
    'shop_db' =>[
      'host'=>'127.0.0.1',
      'port'=>3306,
      'usr'=>'root',
      'password'=>'***',
      'database'=>'exshop',
    ],
];
//define some parameters
$container['cookie_name'] = 'SESSION_ID';
$container['session_storage_class'] = 'SessionStorage';
```



#### 8.3.3 å·¥å‚æ¨¡å¼bind

ä¸‹ä¾‹å·¥å‚æ¨¡å¼ä¸‹ï¼Œæ¯è°ƒç”¨ä¸€æ¬¡éƒ½ä¼šäº§ç”Ÿä¸€ä¸ªæ–°çš„SessionStorageå®ä¾‹ã€‚

``` javascript
$container->bind('sesion_storeage',function($key,$container){
    return new SessionStorage('SESSION_ID');
});
$sesion_storeage1 = $container['sesion_storeage'];
$sesion_storeage2 = $container['sesion_storeage'];
var_dump($sesion_storeage1 === $sesion_storeage2);//è¿”å›false
```



#### 8.3.4 å•å­æ¨¡å¼bind

ä¸‹ä¾‹å•å­æ¨¡å¼ä¸‹ï¼Œä»»ä½•åœ°æ–¹è°ƒç”¨æœåŠ¡ï¼Œè¿”å›çš„éƒ½æ˜¯åŒä¸€å®ä¾‹ã€‚

``` javascript
$container->bind('session',function($key,$container){
    return $container[$key] = new Session($container['sesion_storeage']);
});

$session1 = $container['session'];
$session2 = $container['session'];
var_dump($session1 === $session2);//è¿”å›true
```



#### 8.3.5 ä½¿ç”¨å‚æ•°

``` javascript
$container->bind('bbs_db',function($key,$container){
    return $container[$key] = new Database($container['dbconfig']['bbs_db']);
});
$container->bind('shop_db',function($key,$container){
    return $container[$key] = new Database($container['dbconfig']['shop_db']);
});

$bbs_db = $container['bbs_db'];

$shop_db = $container['shop_db'];


```



#### 8.3.6 åœ¨å®šä¹‰ä»¥åæ›´æ”¹

``` javascript
//1.ç›´æ¥é‡æ–°èµ‹å€¼
$container['router'] = new SimpleRoute();

//2.ç›´æ¥é‡æ–°bind
$container->bind('session_storage',function($key,$container){
    return new $container['session_storage_class']($container['cookie_name']);
});
```



8.3.7 spfä¸­æ‰©å±•ç”¨æ³•

``` java
use spf\Container\Container;
use spf\Container\IContainer;
//å·¥å‚åŸºç±»
class FactoryBase implements IContainer{
  
    public function __construct(Container $container) {}
  
    public static function register($key, Container $container){
        return new self($container);
    }
}
//å•ä¾‹æ¨¡å¼åŸºç±»
class SingleInstanceBase implements IContainer{

    public function __construct(Container $container) {}
  
    public static function register($key, Container $container){
        return $container[$key] = new self($container);
    }
}

//Fooç¤ºä¾‹ç±»
class Foo extends FactoryBase{
      public function __construct(Container $container){
          $this->request = $container['request'];
          $this->xxx = $container['xxx'];
          //...
       }
}
//Barç¤ºä¾‹ç±»
class Bar extends SingleInstanceBase{
      public function __construct(Container $container){
          $this->request = $container['request'];
          $this->xxx = $container['xxx'];
          //...
       }
}

$container = new Container();
//å·¥å‚æ¨¡å¼å¾—åˆ°Fooå®ä¾‹ï¼Œæ³¨å†Œä¸ºfooï¼Œæ³¨å†Œå®Œæˆåï¼Œåœ¨å…¶å®ƒåœ°æ–¹å°±å¯ä»¥ç›´æ¥ä½¿ç”¨$container['foo']
$foo1 = $container->register('\Foo','foo');
$foo2 = $container['foo'];//å¾—åˆ°æ–°çš„å®ä¾‹Foo
$foo3 = $container['foo'];//å¾—åˆ°æ–°çš„å®ä¾‹Foo

//å•å­æ¨¡å¼å¾—åˆ°Barå®ä¾‹ï¼Œæ³¨å†Œä¸ºbarï¼Œæ³¨å†Œå®Œæˆåï¼Œåœ¨å…¶å®ƒåœ°æ–¹å°±å¯ä»¥ç›´æ¥ä½¿ç”¨$container['bar']
$bar1 = $container->register('\Bar','bar');
//æ³¨å†Œå®Œæˆåï¼Œåœ¨å…¶å®ƒåœ°æ–¹å°±å¯ä»¥ç›´æ¥ä½¿ç”¨
$bar2 = $container['bar'];//ä¸$bar1ä¸ºåŒä¸€å®ä¾‹
$bar3 = $container['bar'];//ä¸$bar1ä¸ºåŒä¸€å®ä¾‹




```

ä»¥ä¸Šç”¨æ³•ï¼Œè¿˜å¯ä»¥çœç•¥registerçš„ç¬¬äºŒå‚æ•°ï¼Œåƒè¿™æ ·ç”¨ï¼š

``` javascript
//ä¸å¸¦ç¬¬äºŒå‚æ•°ï¼Œåˆ™ä»¥ç±»åä¸ºç¬¬äºŒå‚æ•°è¿›è¡Œæ³¨å†Œ
$foo1 = $container->register('\Foo');
$foo2 = $container['\Foo'];//å¾—åˆ°æ–°çš„å®ä¾‹Foo
$foo3 = $container['\Foo'];//å¾—åˆ°æ–°çš„å®ä¾‹Foo

//å¦‚æœä¸å¸¦ç¬¬äºŒå‚æ•°ï¼Œåˆ™ä»¥ç±»åä¸ºç¬¬äºŒå‚æ•°è¿›è¡Œæ³¨å†Œ
$bar1 = $container->register('\Bar');
$bar2 = $container['\Bar'];//ä¸$bar1ä¸ºåŒä¸€å®ä¾‹
$bar3 = $container['\Bar'];//ä¸$bar1ä¸ºåŒä¸€å®ä¾‹
```





























