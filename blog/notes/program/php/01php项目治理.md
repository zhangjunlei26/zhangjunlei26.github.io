Title: 第一章 PHP项目治理

Date:  2015-05-07



# PHP项目治理

## 1 代码治理

### 1.1 为什么要代码治理

- 大文件，长函数
- 重复代码
- 单一功能，多文件跳转
- 出问题时找不到对应文件、方法
- 新写代码不知道该往哪里放
- 上线不知道有哪些依赖
- 理解代码容易，理解流程难



### 1.2 治理方法一：目录设计

- 不同应用分开
- 同一应用全部放一起
- MVC即可，不用太多层
- 最少暴露原理，易于部署

### 1.3 法理方法二：框架使用

- 规范的MVC开发
- 高质量的基础类库
- 快速开发
- 更少的代码量
- 易于监控
- 比较好的维护代码一致性

### 1.4 版本管理

问题：

- 线下开发有版本管理吗？
- 线上部署有版本管理吗？
- 线上线下的版本对应的上吗？
- 回滚怎么处理？

方案：

- 使用git管理线下版本
  
- 使用branch来管理不同的开发分支    
  
  <pre>git checkout –b foobar</pre>
  
- 使用tag上线发布系统
  
  <pre>git tag v3.07.09
  
  git push origin v3.07.09
  
  git checkout –b v3.07.09 v3.07.09</pre>
  
- 回滚直接到前一个tag即可
  
  <pre>git checkout v3.07.08</pre>

### 1.5 配置管理

#### 1.5.1 软链法

- 共用配置：global.conf.php
- 开发环境：dev.conf.php
- foo机房 ：foo.conf.php
- bar机房 ：bar.conf.php
- env.conf.php软链到对应文件
- .gitignore对该文件忽略提交

### 1.5.2 程序自带配置，不同部署不同TAG

### 1.5.3 判断服务器环境变量

### 1.5.4 中心配置法

中心服务器根据不同服务器ip返回不同的配置

### 1.6 好的实践

- 短代码,单函数不超过40行
- 依赖注入 
- 抽象,聚合,封装 
- 约束 > 配置 > 代码 
- 三个层次:
  - 代码优雅,接口优雅;
  - 代码龌龊,接口优雅;
  - 代码龌龊,接口龌龊。

## 2 框架治理
### 2.1 规划
- 简单可信赖 
- 可替代 
- 可伸缩 
- 好维护, 易于迭代
- 拥抱失效 
- 不那么烧钱

例如：

DNS多IDC负载均衡
IDC内LVS/HAProxy/Nginx负载均衡+keepalived(备机，故障转移)
数据存储层：MySQL主从+keepalived/Memcache沲/Redis沲/文件存储/其它服务

### 2.2 MySQL/缓存

-  MySQL部署在SSD可以解决大多数问题 
-  MySQL Master-Slave大多数情况下足够用  
-  memcache/redis使用场景      
    - http://blog.nosqlfan.com/html/3729.html 
-  mc hits/usage/eviction 
-  mc compress 
-  mc多实例部署 

### 2.3 服务
- 即时响应还是后台处理? 
- 队列可以解决大多数后台处理需求 
- Gearman是即时响应服务不错的方案 
- HTTP+JSON也是RPC好方案 
- 后台脚本管理 
    - crontab管理
    - 后台脚本:rc.local -> supervisord
### 2.4 教训
- 活在当下
- 尽可能使用成熟的开源系统,不要DIY 避免过度设计,容易失去假期
- 层次清晰
- 尽量不要跨IDC部署动态应用
- 不要引入太多系统


## 3 项目治理

- 如何防止或者延缓项目烂掉?  
- 如何重构一个烂项目? 
- 如何监控项目运行情况? 
- 海量服务的一些策略

### 3.2 防腐
- 开发分层
    - 数据层:核心工程师 
    - 逻辑层:普通工程师
- 代码review 
    - 容忍烂代码,不容忍烂结构 
- quick&dirty的项目组件化

### 3.3 重构
- 不要轻易重构整个项目 
    - 代码烂不代表运行效率烂
    - 速度慢,先定位瓶颈
    - 经常挂,先定位资源 
- 渐进式重构
    - 烂代码 -> 可重构代码 -> 重构代码 
- 破坏性重构
    - 用户无感知:旧API兼容;新旧数据/系统并行

### 3.4 监控
- 基础监控
    - cpu/memory/load/disk/network/io/traffic 
- 应用监控
    - 调用耗时/访问日志/错误日志 
- 可用性监控
    - sla/延时 
- 业务监控
    - 数据实时性/准确性 
- 移动业务监控
    - 完整数据上报

### 3.5 海量服务
- 可降级服务/有损服务 
- 及早拒绝:守住宝贵的资源
- 灰度策略
- 服务隔离
- 避免雪崩 

